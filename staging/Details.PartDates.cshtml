@inherits Custom.Hybrid.Razor14
@using ToSic.Razor.Blade;

@* Other Dates of Event *@
@{
  var futureDates = AsList(Data["FutureDates"]);
  var pastDates = futureDates.Where(d => d.End.Date < DateTime.Now.Date).Count();

  var item = DynamicModel.Item;
  var eventToolbar = Kit.Toolbar.Empty()
    .Settings(show: "always")
    .New("EventDate", tweak: b => b.Prefill("Event", item.EntityGuid))
    .Data("Registrations", tweak: b => b.Filter("Course", item.EntityId));
}

<div class="app-events6-further-events" @eventToolbar >
  @if (futureDates.Count() == 0 && Edit.Enabled) {
    <h5 class="mb-4 mt-4">@Resources.NoEventDates</h5>
  } else if (futureDates.Count() > 1 || Edit.Enabled) {              
    <h5 class="mb-3 mt-4">@Resources.AllDatesOfThisEvent (@(futureDates.Count() - pastDates))</h5>
  }

  @if (futureDates.Count() > 0) {
    if (Edit.Enabled && pastDates > 0) {
      <small><a href="javascript:void(0)" class="js-app-events6-toggle-expired-dates">@App.Resources.BtnToggleExpiredDate</a></small>
    }
    <ul class="list-group list-group-flush mb-4">
      @foreach (var d in futureDates) {
        var currentEventClass = (DynamicModel.HasEventDate && d.EntityId == DynamicModel.EventDate.EntityId) ? "current" : "";
        var hiddenEvent = ((DynamicModel.HasEventDate && d.End.Date < DateTime.Now.Date) || (d.End.Date < DateTime.Now.Date) ? "event-hidden" : "");
        var dateRegistrations = d.Parents("Registrations");
        var regCount = dateRegistrations == null ? 0 : dateRegistrations.Count;
        var toolbarDate = Kit.Toolbar.Empty()
          .Edit()
          .Copy()
          .Delete()
          .Data("Registrations", tweak: b => b.Tooltip( Resources.LabelRegistrations).Filter("EventDate", d.EntityId));

        <li class="list-group-item mb-0 @currentEventClass @hiddenEvent" @toolbarDate.For(d)>
          <a href="@Link.To(parameters: "details=" + DynamicModel.Item.EntityId + "&dateid=" + d.EntityId)">
            <strong>@d.Start.ToString("d")  @(!d.EndDateIsStartDate ? " - " + d.End.ToString("d") : "")</strong>
            @(Text.Has(d.TitleAddition) ? " - " + d.TitleAddition : "")
            @(Text.Has(d.TimeSpecifics) ? " - " + d.TimeSpecifics : "")
            @if (Edit.Enabled) {
              @("(" + regCount + " " + Resources.LabelRegistrations + ")")
            }
          </a>
        </li>
      }
    </ul>
  }
</div>